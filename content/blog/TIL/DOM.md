---
title: "[TIL] 웹페이지가 렌더링 되는 과정(DOM)"
date: "2021-07-15"
tags: ["TIL", "HTML", "DOM", "CSSOM"]
---
HTML은 웹에서 정보를 쉽게 보여주기 위해서 구조화한 언어이다. 이러한 언어를 마크업(markup)이라고 한다.

### DOM

브라우저의 요청을 받은 서버는 사전에 작성되어 서버에 보관 중인 HTML 문서를 응답한다. HTML은 텍스트로 작성되어 있는 문서다. 이 문서를 시각적인 픽셀로 화면에 그려주려면(렌더링), 이 텍스트를 '브라우저가 이해할 수 있는 자료구조' 즉, **객체**로 변환해야 한다.

그것이 바로 **DOM (Document Objecet Model)**이다. DOM은 HTML 문서가 렌더링 엔진에 의해 파싱되어 생성된 노드들로 구성된 트리 자료구조인 것이다.

> 1. 브라우저가 서버에 요청을 보낸다.
> 2. 서버는 브라우저가 요청을 보낸 HTML 파일을 읽어 들여 메모리에 저장한 다음, 메모리에 저장된 바이트(2진수)를 응답한다.
> 3. 응답된 2진수 형태의 HTML 문서는 meta 태그의 charset 어트리뷰트에 의해 지정된 인코딩 방식(UTF-8)을 기준으로 브라우저가 문자열로 변환한다. 이때 meta 태그의 인코딩 방식은 응답 header의 ```content-type```에 담겨 전달된다.
> 4. 브라우저는 문자열을 읽으며 문법적 의미를 갖는 최소 단위인 토큰들로 분해한다. 그리고 각 토큰을 객체로 변환하여 노드들을 생성한다. (document node, text node, element node, attribute node)
> 5. 중첩 관계를 갖는 HTML 요소들에 의해 부자 관계가 반영된 노드들이 트리 자료구조로 구성된다. 그것이 바로 DOM!



### CSSOM

렌더링 엔진은 HTML을 파싱하며 DOM을 생성해 나가다가, CSS를 로드하는 ```<link>``` 태그나 ```<style>``` 태그를 만나면 DOM 생성을 일시 중단한다. 해당 태그에 지정된 CSS 파일을 서버에게 요청하여 **CSSOM (CSS Object Model)**을 생성한다. 

CSSOM은 DOM과 동일한 과정을 거쳐 생성되는데, 생성이 모두 완료되면 다시 중단된 지점에서부터 HTML을 파싱하며 DOM을 생성하게되는 것이다. CSSOM은 CSS의 '상속'을 반영하여 생성된다.



### Javascript

브라우저의 렌더링 엔진은 HTML 문서를 파싱해 나가다가 ```<script>``` 태그를 만나도, DOM 생성을 일시 중단한다. 

> \<script> 태그가 \<body>의 하단에 위치하는 이유이다.
>
> 자바스크립트에 DOM이나 CSSOM을 변경하는 코드가 포함되어 있다면, 아직 생성되지도 않은 노드를 조작하려고 시도하여 오류가 발생할 수 있기 때문이다. 
>
> 또한 하단에 위치하면 HTML 요소들이 렌더링 된 후 자바스크립트를 로딩하기 때문에 페이지 로딩 시간이 단축된다는 장점도 있다.
>
> *HTML5에서는 이러한 문제를 해결하기 위해 HTML 파싱과 자바스크립트 파일 로드를 비동기적으로 처리하도록 돕는 ```async```와 ```defer```가 도입되었다. [링크](https://ko.javascript.info/script-async-defer)

\<script> 태그에 정의된 자바스크립트 파일을 서버로부터 로드하면 자바스크립트를 파싱하기 위해 ```자바스크립트 엔진```에 제어권을 넘긴다. 

자바스크립트 엔진은 자바스크립트 코드를 CPU가 이해할 수 있는 low-level-language로 변환하고 실행하는 역할을 담당한다.

DOM과 CSSOM 처럼 자바스크립트 엔진은 자바스크립트를 해석하여 추상적 구문 트리 AST (Abstract Syntax Tree)를 생성한다. 그리고 AST를 기반으로 [바이트코드](https://ko.wikipedia.org/wiki/%EB%B0%94%EC%9D%B4%ED%8A%B8%EC%BD%94%EB%93%9C)를 생성하여 실행한다.



### Render Tree

HTML과 CSS가 파싱되어 생성된 DOM과 CSSOM은 렌더링을 위한 트리 자료구조인 렌더 트리로 결합된다. 렌더링을 위해 생성되는 구조이기 때문에 화면에 그려지지 않는 meta 태그, script 태그 등의 노드는 포함되지 않는다.

완성된 렌더 트리는 HTML 요소의 위치와 크기(**레이아웃**)를 계산하는 데 사용되고, 브라우저 화면에 픽셀을 렌더링하는 **페인팅** 처리에 입력된다.

렌더링 이후, 

+ 자바스크립트에 의해 HTML이 조작되어 노드가 추가 또는 삭제되는 경우 
+ 브라우저 창의 크기가 바뀌어 뷰포트가 리사이징 되는 경우 
+ 레이아웃과 관련된 스타일이 변경되는 경우

위와 같은 상황이 발생하면 재차 **변경된 DOM/CSSOM 렌더 트리 결합 - 레이아웃 계산 - 페인팅** 과정이 실행된다. 이처럼 레이아웃 계산을 다시 하는 것을 **리플로우**라고 한다. 다시 페인팅 하는 것은 **리페인트**이다. 따라서 레이아웃에 영향이 없는 변경이 생기면 리플로우 없이 리페인트만 실행되기도 한다. 리플로우는 비용이 큰 작업이기 때문에 최소화 하는 것이 효율적이다.