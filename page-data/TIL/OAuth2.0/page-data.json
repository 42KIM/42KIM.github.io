{"componentChunkName":"component---src-templates-blog-post-js","path":"/TIL/OAuth2.0/","result":{"data":{"site":{"siteMetadata":{"title":"42Log"}},"markdownRemark":{"id":"09a374cc-1596-513f-97b3-3ab58e7d358e","excerpt":"은 웹, 모바일 등의 애플리케이션 API 접근에 대한 사용자 인증을 허가하는 프로토콜이다. 사용자의 권한을 위임받은 한 서비스가 제 3의 서비스에서 사용자와 관련된 API…","html":"<p><code class=\"language-text\">OAuth 2.0</code>은 웹, 모바일 등의 애플리케이션 API 접근에 대한 사용자 인증을 허가하는 프로토콜이다. 사용자의 권한을 위임받은 한 서비스가 제 3의 서비스에서 사용자와 관련된 API를 활용할 수 있도록 만들어주는 ‘대리 인증 방식’이라고도 할 수 있을 것 같다. 쇼핑몰 사이트에서의 네이버 계정으로 로그인하기를 떠올리면 된다. <code class=\"language-text\">passport.js</code>는 OAuth 2.0을 쉽게 활용할 수 있도록 도와주는 <code class=\"language-text\">OAuth 2.0 Strategy</code>를 제공한다.</p>\n<h4>OAuth 2.0</h4>\n<p>OAuth 2.0에는 3자 간의 소통을 필요로 한다. 서비스를 사용하려는 User를 지칭하는 <code class=\"language-text\">Resource Owner</code>, 사용자 관련 정보 즉, API를 제공하는 제3의 애플리케이션을 지칭하는 <code class=\"language-text\">Resource Server</code>, 그리고 사용자가 이용하고자 하는 본래의 서비스인 <code class=\"language-text\">Client</code> 간의 상호작용이 일어난다. 이 글에서는 편의상 RO, RS, Client 라고 지칭한다.</p>\n<blockquote>\n<p>사실 엄밀하게 따지면 Resource Server와 Authorization Server가 구분된다. 총 4자 간의 소통?</p>\n</blockquote>\n<p>OAuth 2.0의 진행은 크게 3단계로 구분할 수 있다.</p>\n<ol>\n<li>client와 RO 간의 인증 요청과 허가</li>\n<li>client와 RS 간의 인증 요청과 허가</li>\n<li>client와 RS 간의 정보 요청과 제공</li>\n</ol>\n<h4>Google 계정으로 로그인하기</h4>\n<p>’<strong>철수</strong>가 <strong>B쇼핑몰</strong>에서 <strong>Google 계정으로 로그인하기</strong>’ 기능을 사용하기 위해서는 어떤 과정을 거쳐야 하는지 OAuth 2.0 진행흐름을 정리해본다.</p>\n<p><strong>0. Client 등록</strong></p>\n<p>모든 진행 과정에 앞서, B쇼핑몰은는 Google의 API를 이용하려면 <strong>자격(Credential)</strong>을 얻어야 한다. 자격은 <strong>등록</strong>이라는 과정을 거쳐서 얻을 수 있다. 이를 위해 B쇼핑몰은 <code class=\"language-text\">Google 클라우드 플랫폼</code>에서 쇼핑몰 정보를 등록하여 OAuth 2.0을 사용하기 위한 자격을 얻어야 한다. 성공적으로 등록되면, Google은 쇼핑몰에 OAuth 2.0 <code class=\"language-text\">클라이언트 ID, 클라이언트 SECRET</code>이라는 Credential을 발급한다. </p>\n<blockquote>\n<p> <strong>Redirect URI</strong></p>\n<p><strong>등록</strong> 과정에서 쇼핑몰이 구글에 제공해야 하는 정보 중에 Redirect URI이라는 것이 있다. 추후에 사용자가 구글에게 ‘나는 B쇼핑몰에 정보 제공하는 것을 동의하겠다’라고 말하면 구글은 그 허가 내용을 담은 코드(Authorization Code)를 발급하게 되는데, 쇼핑몰은 이 코드를 사용하여 구글에게 사용자A의 정보를 요청할 수 있게 되는 것이다. 따라서 구글이 발급하는 코드를 전달받을 주소가 필요한데, 그 주소가 Redirect URI인 것이다. 이 글에서는 Redirect URI을 <strong><a href=\"http://bshop.com/auth/google/callback\">http://bshop.com/auth/google/callback</a></strong>라고 가정한다.</p>\n<p>이제 Google은 B쇼핑몰의 client ID, client Secret, Redirect URI 등의 정보를 보유하게 되었다.</p>\n</blockquote>\n<p><strong>1. client와 RO 간의 인증 요청과 허가</strong></p>\n<p>등록을 마치면, 비로소 첫 번째 단계로 진입한다. </p>\n<p>첫 번째 단계는 <strong>철수-B쇼핑몰</strong> 간에 동의를 구하는 과정이라고 할 수 있다. B쇼핑몰은 철수에게, 자신들이 철수의 Google 정보 중에서 어떤 것들을 활용할 것인지(<strong><code class=\"language-text\">scope</code></strong>), Google의 어떤 기능을 이용할 것인지를 알려주고 이러한 사실에 대해서 철수에게 동의를 구해야 한다. 이를 위해서 B쇼핑몰은 ‘Google 계정으로 로그인하기’ 버튼 클릭 시, Google의 <code class=\"language-text\">Authorization Server</code>로 사용자를 보내줘야한다. 철수가 B쇼핑몰의 로그인 페이지에서 ‘Google 계정으로 로그인하기’ 버튼을 클릭했을 때 뜨는 아래의 화면이 바로 이 과정이다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/698fbff29e80d301e9a43d9eb3d5b99d/7527b/oauth_img.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 114.55696202531647%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAABJ0AAASdAHeZh94AAAChUlEQVQ4y51Uy27TQBT1D5W+WKDSFyC6QPwG/4LEmg9gzaJJmyZNkZDY8wOskEjpI36PPWN7bM/h3jEuSZq6pVc6moevz9y3s7e7jc2NNWysr9p1fW0Fb98c4ODgNZ5vPcOrl/sW+3s72NnewtrqCuk8uQH/93Rz3f77Yn8XzmHvEEdHffT7vQa9Hs7GpzgdjTAaDmkdYngywJjuvpydYUTnWVg9Wk8GAxwfH8ERcYw8zyGlRJIkUEpB6xIwBix1XeGhUhQFnDD0EQsBz/MQRRHiWFgwcVVVKMvSQmvdCdaVMoWTkXXGWlKTUeYW+L6+Od+tw5JlGRw2k6X5OO+C+XuhshyZVnN3y/Q4dAuE82Cp6HVJIVGpILfqTt0HEUqpcHF5Sbiy+0cT0g3KyuBXUGMapEjIyiAIHu7yMmFFXdaU5cpmsStxc4R8waWSUi0qldmajKg+mWTxgbswR8iBT1IJSWSKUi+pBvnMhNaCDqLWQtMSlrqAyAwmQYVAGkINL62hrXHdRDeEy2JYG6BJRYPHiCXktuGYxVGIKAyRJgJhGFEr+vD9gGIb2zWgb67rQYjEwvUjTL0QfigwpX2eF9TL7HKpLcHP82ucX/mYXHq27ibnv+FSf4fU3z6VS9vn06lLdzGuowIXQUGrxsQvkJemIWSXufllXkNpIJYaaZraImYX/kdU28ucAFXQC+Xyol0sj9nC//xd4ePXFN9+UC4qG8MCaW7gigqxqm+VSGeraYN3n0LsvHfxYZzyRJztFHOrlWbJ7mrPWcloKjltnMw9nbD4CGbMaM92HnJCeNNOkvvq7N90lhY8oLlTmslNLgvRjHvOLBN3oSVp9ZtqaM4MIWL8AZIJzkSmnFdtAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"이미지\"\n        title=\"이미지\"\n        src=\"/static/698fbff29e80d301e9a43d9eb3d5b99d/f058b/oauth_img.png\"\n        srcset=\"/static/698fbff29e80d301e9a43d9eb3d5b99d/c26ae/oauth_img.png 158w,\n/static/698fbff29e80d301e9a43d9eb3d5b99d/6bdcf/oauth_img.png 315w,\n/static/698fbff29e80d301e9a43d9eb3d5b99d/f058b/oauth_img.png 630w,\n/static/698fbff29e80d301e9a43d9eb3d5b99d/7527b/oauth_img.png 754w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n<em>(Google에게 이름, 이메일 주소, 언어 환경설정, 프로필 사진을 공유하는 것에 대해 동의를 구하는 페이지)</em></p>\n<p>철수가 B쇼핑몰이 자신의 어떠어떠한 Google 계정 정보를 취할 것이며, Google에서 어떤 기능을 사용할 것인지에 대해서 확인하여 동의하기 버튼을 누르면, Google은 이러한 동의 내용을 담은 <code class=\"language-text\">Authorization Code</code>를 발급한다. 동시에 Google은 위에서 설명했던 redirect uri로 철수와 Authorization Code를 함께 보내주게 된다. 이 과정을 통해  철수는 B쇼핑몰이 아닌 Google에게 본인 인증을 한 것이고, B쇼핑몰은 Google이 철수를 인증했다는 사실을 전달받는 것이다. 따라서 B쇼핑몰은 철수를 직접적으로 인증할 필요도, 철수의 민감한 개인정보를 직접 관리할 필요도 없어지는 것이다.</p>\n<p>이렇게 B쇼핑몰은 철수에게 철수의 Google 계정 정보 중 특정한 내용들(scope)을 자신들이 활용하겠다는 동의를 얻었고, 그 증거로서 Authorization Code까지 획득하게 된 것이다.</p>\n<p><strong>2. client와 RS 간의 인증 요청과 허가</strong></p>\n<p>이제 B쇼핑몰은 철수의 동의를 얻었다는 사실을 Google에게 증명하여, 실제 철수의 정보를 얻기위한 자격을 얻어내야 한다. 그 자격이 바로 <code class=\"language-text\">Access Token</code>이다. 이번 단계는 B쇼핑몰이 Google의 Authorization Server에 Access Token을 요청하는 과정인 것이다.</p>\n<p>B쇼핑몰이 Google Authorizaion Server에 Access Token을 요청하면, Google 서버는 B쇼핑몰의 client ID, client Secret, redirect URI 그리고 조금 전 단계에서 발급한 Authorization Code 등이 유효한지 검증한다. 이 검증을 통과하면 Google은 B쇼핑몰에 비로소 Access Token(그리고 Refresh Token이라는 것도)을 발행한다. 이때, Access Token은 redirect uri의 query string에 담겨서 B쇼핑몰에 전달된다. 이 토큰에는 “Google 계정을 사용하는 철수가 자신의 특정 정보를 Google로부터 client ID를 발급받은 B쇼핑몰에게 제공하는 허용했다”는 의미가 담긴 것으로 생각하자.</p>\n<p>이로써 B쇼핑몰은 Google에게 철수의 정보를 요청할 수 있는 자격까지 얻었다. 이제 남은 것은 B쇼핑몰이 발급받은 토큰을 사용하여 Google로부터 철수의 정보를 얻는 과정뿐이다.</p>\n<p><strong>3. client와 RS 간의 정보 요청과 제공</strong></p>\n<p>B쇼핑몰은 Google의 Authorization Server로부터 발급받은 Access Token을 가지고 이제는 Google의 Resource Server에 철수의 정보를 요청해야 한다.</p>\n<p>이제 Google이 정해놓은 API 사용을 위한 요청 방식에 맞게 Access Token을 전송하면, Google은 scope를 통해 사용하기로 약속한 철수의 정보들을 B쇼핑몰에 응답해주는 것이다.</p>\n<h4>참고</h4>\n<p><a href=\"https://datatracker.ietf.org/doc/html/rfc6749#section-1.3.1\">The OAuth 2.0 Authorization Framework</a><br>\n<a href=\"http://www.passportjs.org/docs/oauth/\">Passport Documentation</a><br>\n<a href=\"https://www.opentutorials.org/course/3413\">Opentutorials.org</a></p>","frontmatter":{"title":"[TIL] 구글 계정으로 로그인하기(OAuth 2.0)","date":"May 10, 2021","description":null}},"previous":{"fields":{"slug":"/tutorials/Node.js+MySQL/"},"frontmatter":{"title":"[Docs] Node.js + MySQL"}},"next":{"fields":{"slug":"/tutorials/ejs/"},"frontmatter":{"title":"[Docs] EJS 초간단 사용법"}}},"pageContext":{"id":"09a374cc-1596-513f-97b3-3ab58e7d358e","previousPostId":"9e700b70-7527-5bc8-926e-1a1188e04f48","nextPostId":"f3ca6845-90ce-5126-a439-078a39c5cac2"}},"staticQueryHashes":["2841359383","3257411868"]}